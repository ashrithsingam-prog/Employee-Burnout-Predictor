{% extends "base.html" %}
{% block title %}Dashboard â€” BurnShield{% endblock %}

{% block content %}
<div class="page-header">
    <div class="eyebrow"><span class="eyebrow-line"></span>Wellness Dashboard<span class="eyebrow-line"></span></div>
    <h1>Your <em>Wellbeing</em> Overview</h1>
    <p>Track your burnout risk, view assessment history, and access support resources.</p>
</div>

<!-- KPI ROW -->
<div class="kpi-grid">
    <div class="kpi green">
        <div class="kpi-icon">ğŸ¯</div>
        <div class="kpi-label">Burnout Score</div>
        <div class="kpi-val">{{ burnout.adjusted_score }}%</div>
        <div class="kpi-sub">Composite weighted score</div>
    </div>
    <div
        class="kpi {% if burnout.risk_level == 'low' %}green{% elif burnout.risk_level == 'moderate' %}amber{% elif burnout.risk_level == 'high' %}red{% else %}red{% endif %}">
        <div class="kpi-icon">âš¡</div>
        <div class="kpi-label">Risk Level</div>
        <div class="kpi-val">{{ burnout.risk_level|upper }}</div>
        <div class="kpi-sub">Current risk assessment</div>
    </div>
    <div class="kpi blue">
        <div class="kpi-icon">ğŸ“</div>
        <div class="kpi-label">Assessments</div>
        <div class="kpi-val">{{ assessments|length }}</div>
        <div class="kpi-sub">Total completed assessments</div>
    </div>
    <div class="kpi purple">
        <div class="kpi-icon">ğŸ“…</div>
        <div class="kpi-label">Last Assessment</div>
        <div class="kpi-val" style="font-size:1.1rem">{{ burnout.last_assessment_date or 'None' }}</div>
        <div class="kpi-sub">Most recent completion</div>
    </div>
</div>

<!-- HR Actions Notifications -->
{% if hr_actions %}
<div class="card"
    style="border-left:3px solid var(--green);background:linear-gradient(135deg,rgba(52,211,153,.06),rgba(52,211,153,.02));margin-bottom:1.5rem">
    <div class="card-header" style="color:var(--green)">&#128276; HR Has Taken Action For You
        <span class="badge badge-green" style="margin-left:.5rem">{{ hr_actions|length }} action{{ 's' if
            hr_actions|length > 1 }}</span>
    </div>
    <p style="font-size:.78rem;margin-bottom:1rem">Your HR team has noticed your workload and taken the following steps
        to support you. Feel free to reach out to HR for follow-up.</p>
    {% for action in hr_actions|reverse %}
    <div
        style="display:flex;align-items:flex-start;gap:.7rem;padding:.8rem 1rem;margin-bottom:.6rem;background:var(--surface2);border-radius:10px;border:1px solid var(--border)">
        <div style="flex-shrink:0;font-size:1.3rem">
            {% if action.action_type == 'schedule_1on1' %}&#128197;
            {% elif action.action_type == 'grant_leave' %}&#127796;
            {% elif action.action_type == 'reduce_workload' %}&#128200;
            {% elif action.action_type == 'counseling_referral' %}&#128154;
            {% elif action.action_type == 'task_redistribution' %}&#128257;
            {% else %}&#10024;{% endif %}
        </div>
        <div style="flex:1;min-width:0">
            <div style="font-weight:700;font-size:.88rem;color:var(--ink);margin-bottom:.25rem">
                {{ action.action_type|replace('_', ' ')|title }}
            </div>
            <div style="font-size:.78rem;color:var(--ink2);margin-bottom:.3rem">{{ action.details }}</div>
            <div style="font-size:.68rem;color:var(--muted)">
                {{ action.timestamp }} &middot;
                <span class="badge badge-green" style="font-size:.58rem">{{ action.status }}</span>
            </div>
        </div>
    </div>
    {% endfor %}
    <div
        style="margin-top:.8rem;padding:.6rem .8rem;background:rgba(52,211,153,.08);border-radius:8px;font-size:.75rem;color:var(--green)">
        &#128161; <strong>Need to talk?</strong> Contact your HR manager directly to discuss these actions or request
        additional support.
    </div>
</div>
{% endif %}

<!-- Team HR Actions (Managers only) -->
{% if employee.is_manager and team_actions %}
<div class="card"
    style="border-left:3px solid var(--blue);background:linear-gradient(135deg,rgba(59,130,246,.06),rgba(59,130,246,.02));margin-bottom:1.5rem">
    <div class="card-header" style="color:var(--blue)">ğŸ‘” Team Updates From HR
        <span class="badge badge-blue" style="margin-left:.5rem">{{ team_actions|length }} action{{ 's' if
            team_actions|length > 1 }}</span>
    </div>
    <p style="font-size:.78rem;margin-bottom:1rem;color:var(--muted2)">HR has taken the following actions for members of
        your team. These are provided for your awareness so you can support your team.</p>
    {% for item in team_actions[:8] %}
    <div
        style="display:flex;align-items:flex-start;gap:.7rem;padding:.8rem 1rem;margin-bottom:.5rem;background:var(--surface2);border-radius:10px;border:1px solid var(--border)">
        <div style="flex-shrink:0;font-size:1.3rem">
            {% if item.action.action_type == 'schedule_1on1' %}ğŸ“…
            {% elif item.action.action_type == 'grant_leave' %}ğŸŒœ
            {% elif item.action.action_type == 'reduce_workload' %}ğŸ“ˆ
            {% elif item.action.action_type == 'counseling_referral' %}ğŸ’š
            {% elif item.action.action_type == 'task_redistribution' %}ğŸ“
            {% else %}âœ¨{% endif %}
        </div>
        <div style="flex:1;min-width:0">
            <div style="font-weight:700;font-size:.82rem;color:var(--ink);margin-bottom:.2rem">
                {{ item.employee_name }}
                <span style="font-size:.68rem;color:var(--muted);font-weight:400;margin-left:.3rem">{{ item.employee_id
                    }}</span>
            </div>
            <div style="font-size:.78rem;color:var(--ink2);margin-bottom:.2rem">
                {{ item.action.action_type|replace('_', ' ')|title }} â€” {{ item.action.details }}
            </div>
            <div style="font-size:.68rem;color:var(--muted)">
                {{ item.action.timestamp }} Â·
                <span class="badge badge-green" style="font-size:.58rem">{{ item.action.status }}</span>
            </div>
        </div>
    </div>
    {% endfor %}
    <div
        style="margin-top:.8rem;padding:.6rem .8rem;background:rgba(59,130,246,.08);border-radius:8px;font-size:.75rem;color:var(--blue)">
        ğŸ’¡ <strong>Your role:</strong> These actions are confidential. Please be supportive if your team members need
        schedule adjustments or time off.
    </div>
</div>
{% elif employee.is_manager and not team_actions %}
<div class="card" style="border-left:3px solid var(--blue);margin-bottom:1.5rem">
    <div class="card-header" style="color:var(--blue)">ğŸ‘” Team Updates From HR</div>
    <p style="font-size:.82rem;color:var(--muted2);padding:.5rem 0">No HR actions have been taken for your team members
        yet. This section will update when HR takes action.</p>
</div>
{% endif %}

<div class="grid-sidebar">
    <!-- LEFT: Profile -->
    <div class="card profile-card">
        <div class="profile-avatar">ğŸ‘¤</div>
        <div class="profile-name">{{ employee.name }}</div>
        <div class="profile-role">{{ employee.role }} Â· {{ employee.department }}</div>
        <div class="profile-stat"><span>Employee ID</span> <span>{{ employee.id }}</span></div>
        <div class="profile-stat"><span>Email</span> <span style="font-size:.75rem">{{ employee.email }}</span></div>
        <div class="profile-stat"><span>Joined</span> <span>{{ employee.join_date }}</span></div>
        <div class="profile-stat"><span>Risk Level</span>
            <span
                class="badge badge-{% if burnout.risk_level == 'low' %}green{% elif burnout.risk_level == 'moderate' %}amber{% elif burnout.risk_level == 'high' %}red{% else %}red{% endif %}">
                {{ burnout.risk_level|upper }}
            </span>
        </div>
    </div>

    <!-- RIGHT: Breakdown + CTAs -->
    <div>
        <!-- Wellness Ring -->
        <div class="card" style="text-align:center;margin-bottom:1.2rem">
            <div class="card-header" style="justify-content:center">Overall Wellness</div>
            {% set score = burnout.adjusted_score %}
            {% set circumference = 326.7 %}
            {% set offset = circumference - (score / 100) * circumference %}
            {% if score < 40 %}{% set ring_color="var(--green)" %} {% elif score < 60 %}{% set ring_color="var(--amber)"
                %} {% else %}{% set ring_color="var(--red)" %}{% endif %} <div class="wellness-ring">
                <svg viewBox="0 0 120 120">
                    <circle class="bg" cx="60" cy="60" r="52"></circle>
                    <circle class="fill" cx="60" cy="60" r="52" stroke="{{ ring_color }}"
                        stroke-dasharray="{{ circumference }}" stroke-dashoffset="{{ offset }}"></circle>
                </svg>
                <div class="label">
                    <span class="val" style="color:{{ ring_color }}">{{ score }}</span>
                    <span class="sub">Burnout %</span>
                </div>
        </div>
    </div>

    <!-- Score Breakdown -->
    <div class="card" style="margin-bottom:1.2rem">
        <div class="card-header">ğŸ“ˆ Score Breakdown</div>
        {% for key, item in burnout.breakdown.items() %}
        {% set val = item.score %}
        {% if val < 30 %}{% set c="var(--green)" %}{% set tag_class="badge-green" %}{% set level="Low" %} {% elif val <
            50 %}{% set c="var(--amber)" %}{% set tag_class="badge-amber" %}{% set level="Moderate" %} {% elif val < 70
            %}{% set c="var(--red)" %}{% set tag_class="badge-amber" %}{% set level="High" %} {% else %}{% set
            c="var(--red)" %}{% set tag_class="badge-red" %}{% set level="Critical" %}{% endif %} <div class="meter">
            <div class="meter-head">
                <span class="meter-label">{{ key|replace('_', ' ')|title }}</span>
                <span class="badge {{ tag_class }}" style="font-size:.6rem">{{ level }}</span>
                <span class="meter-pct" style="color:{{ c }}">{{ val }}%</span>
            </div>
            <div class="meter-track">
                <div class="meter-fill" style="width:{{ val }}%;background:{{ c }}"></div>
            </div>
    </div>
    {% endfor %}
</div>

<!-- LAST 4 WEEKS WORK TRACKER -->
<div class="card mt-3">
    <div class="card-header">&#128202; Last 4 Weeks â€” Work Activity Tracker</div>
    <p style="font-size:.78rem;margin-bottom:1.2rem">Your weekly work patterns. High hours, weekend activity, and low
        breaks may indicate early burnout risk.</p>
    <div class="table-wrap">
        <table class="data-table" style="font-size:.82rem">
            <thead>
                <tr>
                    <th>Week</th>
                    <th>Avg Daily Hrs</th>
                    <th>Weekend Screen Time</th>
                    <th>Tasks Done</th>
                    <th>Late Nights</th>
                    <th>Breaks/Day</th>
                </tr>
            </thead>
            <tbody>
                {% for log in work_logs %}
                {% set hrs_color = 'var(--green)' if log.avg_daily_hours <= 9 else ('var(--amber)' if
                    log.avg_daily_hours <=11 else 'var(--red)' ) %} {% set wk_color='var(--green)' if
                    log.weekend_screen_time <=1 else ('var(--amber)' if log.weekend_screen_time <=3 else 'var(--red)' )
                    %} {% set ln_color='var(--green)' if log.late_night_sessions <=1 else ('var(--amber)' if
                    log.late_night_sessions <=3 else 'var(--red)' ) %} <tr>
                    <td style="font-weight:600;color:var(--ink)">{{ log.week_start }}</td>
                    <td>
                        <span style="font-weight:700;color:{{ hrs_color }}">{{ log.avg_daily_hours }}h</span>
                        <div class="meter-track" style="margin-top:4px">
                            <div class="meter-fill"
                                style="width:{{ (log.avg_daily_hours / 14 * 100)|round }}%;background:{{ hrs_color }}">
                            </div>
                        </div>
                    </td>
                    <td>
                        <span style="font-weight:700;color:{{ wk_color }}">{{ log.weekend_screen_time }}h</span>
                        <div class="meter-track" style="margin-top:4px">
                            <div class="meter-fill"
                                style="width:{{ (log.weekend_screen_time / 8 * 100)|round }}%;background:{{ wk_color }}">
                            </div>
                        </div>
                    </td>
                    <td style="font-weight:600">{{ log.tasks_completed }} / {{ log.tasks_assigned }}</td>
                    <td><span style="font-weight:700;color:{{ ln_color }}">{{ log.late_night_sessions }}</span></td>
                    <td>{{ log.breaks_taken_per_day }}</td>
                    </tr>
                    {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- CTAs -->
<div class="grid-2">
    <div class="book-card">
        <h4>Take Assessment</h4>
        <p style="font-size:.8rem">Complete a quick burnout check-in to update your score.</p>
        <a href="{{ url_for('assessment') }}" class="btn btn-sm">Start Assessment â†’</a>
    </div>
    <div class="book-card"
        style="background:linear-gradient(135deg,var(--purple-dim),var(--blue-dim));border-color:rgba(167,139,250,.15)">
        <h4>Peer Report</h4>
        <p style="font-size:.8rem">Noticed something? Submit a confidential concern.</p>
        <a href="{{ url_for('peer_report') }}" class="btn btn-outline btn-sm">Submit Report â†’</a>
    </div>
</div>
</div>
</div>
{% endblock %}