{% extends "base.html" %}
{% block title %}HR Dashboard â€” BurnShield{% endblock %}

{% block content %}
<div class="page-header">
    <div class="eyebrow"><span class="eyebrow-line"></span>HR Administration<span class="eyebrow-line"></span></div>
    <h1>Employee <em>Wellbeing</em> Overview</h1>
    <p>System-wide burnout analytics, employee risk levels, and actionable insights.</p>
</div>

<!-- KPIs -->
<div class="kpi-grid">
    <div class="kpi blue">
        <div class="kpi-icon">ğŸ‘¥</div>
        <div class="kpi-label">Total Employees</div>
        <div class="kpi-val">{{ total }}</div>
        <div class="kpi-sub">Active in the system</div>
    </div>
    <div class="kpi green">
        <div class="kpi-icon">ğŸ“Š</div>
        <div class="kpi-label">Avg Burnout Score</div>
        <div class="kpi-val">{{ avg_score }}%</div>
        <div class="kpi-sub">Across all employees</div>
    </div>
    <div class="kpi red">
        <div class="kpi-icon">ğŸ”¥</div>
        <div class="kpi-label">At Risk</div>
        <div class="kpi-val">{{ at_risk }}</div>
        <div class="kpi-sub">High/Critical risk employees</div>
    </div>
    <div class="kpi purple">
        <div class="kpi-icon">ğŸ“©</div>
        <div class="kpi-label">Peer Reports</div>
        <div class="kpi-val">{{ peer_reports|length }}</div>
        <div class="kpi-sub">Submitted concerns</div>
    </div>
</div>

<!-- Risk Distribution -->
<div class="card" style="margin-bottom:1.5rem">
    <div class="card-header">âš¡ Risk Distribution</div>
    <div class="grid-2" style="grid-template-columns:repeat(4,1fr)">
        {% for level in ['low', 'moderate', 'high', 'critical'] %}
        {% set item = risk_dist[level] %}
        <div style="text-align:center;padding:.8rem">
            <div
                style="font-size:1.6rem;font-weight:800;
                {% if level == 'low' %}color:var(--green){% elif level == 'moderate' %}color:var(--amber){% elif level == 'high' %}color:var(--red){% else %}color:var(--red){% endif %}">
                {{ item.count }}
            </div>
            <div
                style="font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-top:.2rem">
                {{ level }}</div>
            <div style="font-size:.72rem;color:var(--muted2)">{{ item.pct }}%</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Search & Filter -->
<div class="card">
    <div class="card-header">ğŸ‘¥ Employee Database</div>

    <form method="GET" action="{{ url_for('hr_dashboard') }}" class="search-form">
        <input type="text" name="search" placeholder="Search by name, ID, or departmentâ€¦" value="{{ search_query }}"
            style="flex:1;min-width:180px">
        <select name="risk">
            <option value="">All Risk Levels</option>
            <option value="low" {% if risk_filter=='low' %}selected{% endif %}>Low</option>
            <option value="moderate" {% if risk_filter=='moderate' %}selected{% endif %}>Moderate</option>
            <option value="high" {% if risk_filter=='high' %}selected{% endif %}>High</option>
            <option value="critical" {% if risk_filter=='critical' %}selected{% endif %}>Critical</option>
        </select>
        <button type="submit" class="btn btn-sm">Filter</button>
    </form>

    <div class="table-wrap">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Role</th>
                    <th>Burnout Score</th>
                    <th>Risk Level</th>
                    <th>Last Assessment</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in employees %}
                <tr>
                    <td style="font-family:monospace;font-size:.78rem;color:var(--muted)">{{ emp.id }}</td>
                    <td class="emp-name">{{ emp.name }}</td>
                    <td>{{ emp.department }}</td>
                    <td>{{ emp.role }}</td>
                    <td>
                        <span style="font-weight:700;
                            {% if emp.burnout_score < 30 %}color:var(--green)
                            {% elif emp.burnout_score < 50 %}color:var(--amber)
                            {% elif emp.burnout_score < 70 %}color:var(--red)
                            {% else %}color:var(--red){% endif %}">
                            {{ emp.burnout_score }}%
                        </span>
                    </td>
                    <td>
                        <span
                            class="badge badge-{% if emp.risk_level == 'low' %}green{% elif emp.risk_level == 'moderate' %}amber{% elif emp.risk_level == 'high' %}red{% else %}red{% endif %}">
                            {{ emp.risk_level|upper }}
                        </span>
                    </td>
                    <td style="font-size:.78rem;color:var(--muted)">{{ emp.last_assessment or 'Never' }}</td>
                    <td>
                        <a href="{{ url_for('hr_employee_detail', emp_id=emp.id) }}" class="btn btn-outline btn-sm"
                            style="padding:.35rem .8rem;font-size:.72rem">
                            View â†’
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Peer Reports -->
{% if peer_reports %}
<div class="card mt-3">
    <div class="card-header">ğŸ“© Recent Peer Concern Reports</div>
    {% for report in peer_reports[:5] %}
    <div class="alert-item">
        <span class="alert-icon">
            {% if report.concern_type == 'burnout' %}ğŸ”¥
            {% elif report.concern_type == 'workload' %}ğŸ“‹
            {% elif report.concern_type == 'behavior_change' %}ğŸ”„
            {% elif report.concern_type == 'health' %}â¤ï¸
            {% else %}ğŸ“Œ{% endif %}
        </span>
        <div class="alert-body">
            <div class="alert-title">{{ report.reported_employee_name }}
                <span class="badge badge-blue" style="font-size:.58rem;margin-left:.4rem">{{
                    report.concern_type|replace('_', ' ')|title }}</span>
            </div>
            <div class="alert-msg">{{ report.description[:120] }}{% if report.description|length > 120 %}â€¦{% endif %}
            </div>
            <div class="alert-time">Reported {{ report.timestamp }} Â· By {{ report.reporter_name }}</div>
        </div>
        <span class="badge {% if report.status == 'pending' %}badge-amber{% else %}badge-green{% endif %}">{{
            report.status }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}