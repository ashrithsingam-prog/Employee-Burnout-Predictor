{% extends "base.html" %}
{% block title %}HR Dashboard ‚Äî BurnShield{% endblock %}

{% block content %}
<div class="page-header">
    <div class="eyebrow"><span class="eyebrow-line"></span>HR Administration<span class="eyebrow-line"></span></div>
    <h1>Employee <em>Wellbeing</em> Overview</h1>
    <p>System-wide burnout analytics, employee risk levels, and actionable insights.</p>
</div>

<!-- KPIs -->
<div class="kpi-grid">
    <div class="kpi blue">
        <div class="kpi-icon">üë•</div>
        <div class="kpi-label">Total Employees</div>
        <div class="kpi-val">{{ total }}</div>
        <div class="kpi-sub">Active in the system</div>
    </div>
    <div class="kpi green">
        <div class="kpi-icon">üìä</div>
        <div class="kpi-label">Avg Burnout Score</div>
        <div class="kpi-val">{{ avg_score }}%</div>
        <div class="kpi-sub">Across all employees</div>
    </div>
    <div class="kpi red">
        <div class="kpi-icon">üî•</div>
        <div class="kpi-label">At Risk</div>
        <div class="kpi-val">{{ at_risk }}</div>
        <div class="kpi-sub">High/Critical risk employees</div>
    </div>
    <div class="kpi purple">
        <div class="kpi-icon">üì©</div>
        <div class="kpi-label">Peer Reports</div>
        <div class="kpi-val">{{ peer_reports|length }}</div>
        <div class="kpi-sub">Submitted concerns</div>
    </div>
</div>

<!-- Risk Distribution -->
<div class="card" style="margin-bottom:1.5rem">
    <div class="card-header">‚ö° Risk Distribution</div>
    <div class="grid-2" style="grid-template-columns:repeat(4,1fr)">
        {% for level in ['low', 'moderate', 'high', 'critical'] %}
        {% set item = risk_dist[level] %}
        <div style="text-align:center;padding:.8rem">
            <div
                style="font-size:1.6rem;font-weight:800;
                {% if level == 'low' %}color:var(--green){% elif level == 'moderate' %}color:var(--amber){% elif level == 'high' %}color:var(--red){% else %}color:var(--red){% endif %}">
                {{ item.count }}
            </div>
            <div
                style="font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-top:.2rem">
                {{ level }}</div>
            <div style="font-size:.72rem;color:var(--muted2)">{{ item.pct }}%</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Manager Blindspot Alerts -->
{% if manager_blindspots %}
<div class="card" style="margin-bottom:1.5rem; border-left:3px solid var(--purple)">
    <div class="card-header" style="color:var(--purple)">üîç Manager Blindspot Analysis
        <span class="badge badge-purple" style="margin-left:.5rem;font-size:.6rem">SYSTEMIC RISK</span>
    </div>
    <div style="font-size:.78rem;color:var(--muted2);margin-bottom:1rem;line-height:1.5">
        Teams are grouped by their assigned manager. High average burnout scores may indicate systemic leadership issues
        rather than individual problems.
    </div>

    {% for mgr in manager_blindspots %}
    <div style="padding:.8rem 1rem;margin-bottom:.6rem;background:var(--surface2);border-radius:10px;
        {% if mgr.risk == 'critical' %}border-left:3px solid var(--red)
        {% elif mgr.risk == 'high' %}border-left:3px solid var(--red)
        {% elif mgr.risk == 'moderate' %}border-left:3px solid var(--amber)
        {% else %}border-left:3px solid var(--green){% endif %}">

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
            <div>
                <span style="font-weight:700;font-size:.88rem;color:var(--text-main)">{{ mgr.manager_id }}</span>
                <span style="font-size:.72rem;color:var(--muted);margin-left:.5rem">{{ mgr.team_size }} team
                    members</span>
            </div>
            <div style="display:flex;align-items:center;gap:.5rem">
                {% if mgr.high_risk_count > 0 %}
                <span class="badge badge-red" style="font-size:.6rem">{{ mgr.high_risk_count }} at risk</span>
                {% endif %}
                <span style="font-size:1rem;font-weight:800;
                    {% if mgr.avg_score >= 50 %}color:var(--red)
                    {% elif mgr.avg_score >= 30 %}color:var(--amber)
                    {% else %}color:var(--green){% endif %}">{{ mgr.avg_score }}%</span>
            </div>
        </div>

        <!-- Score bar -->
        <div style="width:100%;height:6px;background:var(--bg);border-radius:3px;overflow:hidden;margin-bottom:.5rem">
            <div style="width:{{ mgr.avg_score }}%;height:100%;border-radius:3px;
                {% if mgr.avg_score >= 50 %}background:var(--red)
                {% elif mgr.avg_score >= 30 %}background:var(--amber)
                {% else %}background:var(--green){% endif %}"></div>
        </div>

        <!-- Team members (collapsed by default) -->
        <details style="margin-top:.3rem">
            <summary style="font-size:.72rem;color:var(--accent);cursor:pointer;font-weight:600">View team members
            </summary>
            <div style="margin-top:.5rem;display:flex;flex-wrap:wrap;gap:.4rem">
                {% for member in mgr.members %}
                <a href="{{ url_for('hr_employee_detail', emp_id=member.id) }}"
                    style="display:inline-flex;align-items:center;gap:.3rem;padding:.3rem .6rem;background:var(--bg);border-radius:6px;font-size:.7rem;text-decoration:none;color:var(--text-main);border:1px solid var(--border)">
                    <span style="font-weight:600">{{ member.name }}</span>
                    <span
                        class="badge badge-{% if member.risk_level == 'low' %}green{% elif member.risk_level == 'moderate' %}amber{% else %}red{% endif %}"
                        style="font-size:.55rem;padding:1px 5px">{{ member.score }}%</span>
                </a>
                {% endfor %}
            </div>
        </details>

        {% if mgr.avg_score >= 50 %}
        <div
            style="margin-top:.6rem;padding:.5rem .7rem;background:rgba(239,68,68,.06);border-radius:6px;font-size:.7rem;color:var(--red);line-height:1.4;border:1px solid rgba(239,68,68,.15)">
            ‚ö†Ô∏è <strong>Action Recommended:</strong> This manager's team has an abnormally high average burnout score.
            Consider scheduling a leadership review, workload audit, or team 1-on-1s.
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Search & Filter -->
<div class="card">
    <div class="card-header">üë• Employee Database</div>

    <form method="GET" action="{{ url_for('hr_dashboard') }}" class="search-form">
        <input type="text" name="search" placeholder="Search by name, ID, or department‚Ä¶" value="{{ search_query }}"
            style="flex:1;min-width:180px">
        <select name="risk">
            <option value="">All Risk Levels</option>
            <option value="low" {% if risk_filter=='low' %}selected{% endif %}>Low</option>
            <option value="moderate" {% if risk_filter=='moderate' %}selected{% endif %}>Moderate</option>
            <option value="high" {% if risk_filter=='high' %}selected{% endif %}>High</option>
            <option value="critical" {% if risk_filter=='critical' %}selected{% endif %}>Critical</option>
        </select>
        <button type="submit" class="btn btn-sm">Filter</button>
    </form>

    <div class="table-wrap">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Role</th>
                    <th>Burnout Score</th>
                    <th>Risk Level</th>
                    <th>Last Assessment</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in employees %}
                <tr>
                    <td style="font-family:monospace;font-size:.78rem;color:var(--muted)">{{ emp.id }}</td>
                    <td class="emp-name">{{ emp.name }}</td>
                    <td>{{ emp.department }}</td>
                    <td>{{ emp.role }}</td>
                    <td>
                        <span style="font-weight:700;
                            {% if emp.burnout_score < 30 %}color:var(--green)
                            {% elif emp.burnout_score < 50 %}color:var(--amber)
                            {% elif emp.burnout_score < 70 %}color:var(--red)
                            {% else %}color:var(--red){% endif %}">
                            {{ emp.burnout_score }}%
                        </span>
                    </td>
                    <td>
                        <span
                            class="badge badge-{% if emp.risk_level == 'low' %}green{% elif emp.risk_level == 'moderate' %}amber{% elif emp.risk_level == 'high' %}red{% else %}red{% endif %}">
                            {{ emp.risk_level|upper }}
                        </span>
                    </td>
                    <td style="font-size:.78rem;color:var(--muted)">{{ emp.last_assessment or 'Never' }}</td>
                    <td>
                        <a href="{{ url_for('hr_employee_detail', emp_id=emp.id) }}" class="btn btn-outline btn-sm"
                            style="padding:.35rem .8rem;font-size:.72rem">
                            View ‚Üí
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Peer Reports -->
{% if peer_reports %}
<div class="card mt-3">
    <div class="card-header">üì© Recent Peer Concern Reports</div>
    {% for report in peer_reports[:5] %}
    <div class="alert-item">
        <span class="alert-icon">
            {% if report.concern_type == 'burnout' %}üî•
            {% elif report.concern_type == 'workload' %}üìã
            {% elif report.concern_type == 'behavior_change' %}üîÑ
            {% elif report.concern_type == 'health' %}‚ù§Ô∏è
            {% else %}üìå{% endif %}
        </span>
        <div class="alert-body">
            <div class="alert-title">{{ report.reported_employee_name }}
                <span class="badge badge-blue" style="font-size:.58rem;margin-left:.4rem">{{
                    report.concern_type|replace('_', ' ')|title }}</span>
            </div>
            <div class="alert-msg">{{ report.description[:120] }}{% if report.description|length > 120 %}‚Ä¶{% endif %}
            </div>
            <div class="alert-time">Reported {{ report.timestamp }} ¬∑ By {{ report.reporter_name }}</div>
        </div>
        <span class="badge {% if report.status == 'pending' %}badge-amber{% else %}badge-green{% endif %}">{{
            report.status }}</span>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}