{% extends "base.html" %}
{% block title %}HR Dashboard{% endblock %}

{% block content %}
<div class="page-header fade-up">
    <div class="eyebrow"><span class="eyebrow-line"></span>HR Administration<span class="eyebrow-line"></span></div>
    <h1>Employee <em>Wellbeing</em> Overview</h1>
    <p>System-wide burnout analytics, employee risk levels, and actionable insights.</p>
</div>

<div class="container fade-up">
    <!-- KPI Overview -->
    <div class="kpi-grid">
        <div class="kpi blue">
            <div class="kpi-label">Total Employees</div>
            <div class="kpi-val">{{ total }}</div>
            <div class="kpi-sub">Active in the system</div>
        </div>
        <div class="kpi {% if avg_score >= 50 %}red{% elif avg_score >= 30 %}amber{% else %}green{% endif %}">
            <div class="kpi-label">Avg Burnout Score</div>
            <div class="kpi-val">{{ avg_score }}%</div>
            <div class="kpi-sub">Across all employees</div>
        </div>
        <div class="kpi {% if at_risk > 0 %}red{% else %}green{% endif %}">
            <div class="kpi-label">At Risk</div>
            <div class="kpi-val">{{ at_risk }}</div>
            <div class="kpi-sub">High/Critical risk employees</div>
        </div>
    </div>

    <!-- Risk Distribution -->
    <div class="card mb-3">
        <div class="card-header">Risk Distribution</div>
        <div class="grid-2" style="gap:1rem">
            {% for level, data in risk_dist.items() %}
            {% if level == 'low' %}{% set color = "var(--green)" %}{% set badge_cls = "badge-green" %}
            {% elif level == 'moderate' %}{% set color = "var(--amber)" %}{% set badge_cls = "badge-amber" %}
            {% elif level == 'high' %}{% set color = "var(--red)" %}{% set badge_cls = "badge-red" %}
            {% else %}{% set color = "var(--red)" %}{% set badge_cls = "badge-red" %}{% endif %}
            <div class="meter">
                <div class="meter-head">
                    <span class="badge {{ badge_cls }}">{{ level|upper }}</span>
                    <span class="meter-label"></span>
                    <span class="meter-pct" style="color:{{ color }}">{{ data.count }}</span>
                </div>
                <div class="meter-track">
                    <div class="meter-fill" style="width:{{ data.pct }}%;background:{{ color }}"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Search/Filter -->
    <div class="card mb-3">
        <div class="card-header">Employee Database</div>
        <form method="GET" action="{{ url_for('hr_dashboard') }}" class="search-form">
            <input type="text" name="search" value="{{ search_query or '' }}"
                placeholder="Search by name, ID, or department..." style="margin-bottom:0">
            <select name="risk" style="margin-bottom:0">
                <option value="">All Risk Levels</option>
                <option value="low" {{ 'selected' if risk_filter=='low' }}>Low</option>
                <option value="moderate" {{ 'selected' if risk_filter=='moderate' }}>Moderate</option>
                <option value="high" {{ 'selected' if risk_filter=='high' }}>High</option>
                <option value="critical" {{ 'selected' if risk_filter=='critical' }}>Critical</option>
            </select>
            <button type="submit" class="btn btn-sm">Filter</button>
        </form>

        <div class="table-wrap">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Role</th>
                        <th>Burnout Score</th>
                        <th>Risk Level</th>
                        <th>Last Assessment</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emp in employees %}
                    <tr>
                        <td style="font-weight:600;font-size:.78rem;color:var(--muted)">{{ emp.id }}</td>
                        <td class="emp-name">{{ emp.name }}{% if emp.is_hr %} <span class="badge badge-blue"
                                style="font-size:.6rem">HR</span>{% endif %}</td>
                        <td>{{ emp.department }}</td>
                        <td style="font-size:.82rem;color:var(--muted)">{{ emp.role }}</td>
                        <td>
                            <span
                                style="font-weight:700;font-family:'Playfair Display',serif;color:{% if emp.burnout_score >= 65 %}var(--red){% elif emp.burnout_score >= 35 %}var(--amber){% else %}var(--green){% endif %}">
                                {{ emp.burnout_score }}%
                            </span>
                        </td>
                        <td>
                            {% if emp.risk_level == 'low' %}<span class="badge badge-green">Low</span>
                            {% elif emp.risk_level == 'moderate' %}<span class="badge badge-amber">Moderate</span>
                            {% elif emp.risk_level == 'high' %}<span class="badge badge-red">High</span>
                            {% else %}<span class="badge badge-red">Critical</span>{% endif %}
                        </td>
                        <td style="font-size:.82rem;color:var(--muted)">{{ emp.last_assessment or 'Never' }}</td>
                        <td>
                            <a href="{{ url_for('hr_employee_detail', emp_id=emp.id) }}" class="btn btn-outline btn-sm"
                                style="padding:.3rem .8rem;font-size:.72rem">
                                View â†’
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Peer Reports Summary -->
    {% if peer_reports %}
    <div class="card mb-3" style="border-left:3px solid var(--amber)">
        <div class="card-header">ðŸ“© Peer Concern Reports ({{ peer_reports|length }})</div>
        {% for report in peer_reports[:5] %}
        <div class="alert-item">
            <span class="alert-icon">{% if report.status == 'pending' %}ðŸ”¸{% else %}âœ…{% endif %}</span>
            <div class="alert-body">
                <div class="alert-title">{{ report.concern_type|title }} concern for {{ report.reported_employee_name }}
                </div>
                <div class="alert-msg">{{ report.description[:100] }}{% if report.description|length > 100 %}...{% endif
                    %}</div>
                <div class="alert-time">{{ report.timestamp }} Â· {{ report.reported_department }} Â· {{
                    report.status|capitalize }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}